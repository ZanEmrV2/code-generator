import React, { useEffect, useRef, useState } from 'react';
import { DataTable, DataTableFilterMeta } from 'primereact/datatable';
import { Button } from 'primereact/button';
import { Column } from 'primereact/column';
import { Toast } from 'primereact/toast';
import { ConfirmDialog, confirmDialog } from 'primereact/confirmdialog';
import { Card } from 'primereact/card';
import { TableAction } from '../shared/table-action';
import {
  <%= capEntityName %>,
  <%= capEntityName %>Update,
  useDelete<%= capEntityName %>,
  useFetch<%=capPluralEntityName%>,
  <%=camelEntityName%>DefaultValue,
} from '.';
import {
  IQueryParams,
  ITEMS_PER_PAGE_OPTIONS,
  stringDefaultFilter,
} from '../../utils/utils';

export default function <%= capEntityName %>List() {
  //Config column filters
  const initialOptionFilters: DataTableFilterMeta = {
    <%_ fields.forEach(function(f){ _%>
       <%_ if(f.searchable){ _%>
       <%=f.camelName %>: stringDefaultFilter,
       <%_ } _%>
    <%_ }); _%>
  };

  const perPageOptions = ITEMS_PER_PAGE_OPTIONS;

  const [showCreateOrUpdate, setShowCreateOrUpdate] = useState(false);

  //Selected <%= capEntityName %> to be updated or new <%= capEntityName %>
  const [<%= camelEntityName %>, set<%= capEntityName %>] = useState<<%= capEntityName %>>();

  /** a separeate filter state to avoid data loading on initilization, table columns that can be filtered and they options (i.e not necessary to fetch data)*/
  const [optionalFilters, setOptionalFilters] = useState<DataTableFilterMeta>();

  const toast = useRef<Toast>(null);

  /** pagination option, optional filters ,
   *  useFetch<%=capPluralEntityName%> function observe this state and reload data when any property value is changed
   */
  const [queryParams, setQueryParams] = useState<IQueryParams>({
    first: 0,
    rows: 10,
    page: 0,
    optionalFilters: undefined,
    sortField: undefined,
    sortOrder: undefined,
  });

  const {
    isLoading,
    isError,
    refetch,
    data: <%=camelPluralEntityName%>,
  } = useFetch<%=capPluralEntityName%>({
    queryParams,
  });

  const initFilters = () => {
    setOptionalFilters(initialOptionFilters);
  };

  // When filter cleared init filter state and update queryParam filter property
  const clearFilters = () => {
    initFilters();
    setQueryParams({
      ...queryParams,
      optionalFilters,
    });
  };

  useEffect(() => {
    initFilters();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const deteleMutation = useDelete<%= capEntityName %>({
    onSuccess: () => {
      refetch();
      toast.current?.show({
        severity: 'success',
        summary: 'Deleted successfully',
        detail: '<%= capEntityName %> deleted',
        life: 3000,
      });
    },
  });

  const createOrEdit = (<%=camelEntityName%>Data?: <%= capEntityName %>) => {
    const data = <%=camelEntityName%>Data || <%=camelEntityName%>DefaultValue;
    set<%= capEntityName %>(data);
    setShowCreateOrUpdate(true);
  };

  const closeDialog = (result: boolean) => {
    setShowCreateOrUpdate(false);
    set<%= capEntityName %>(undefined);
    if (result) {
      refetch();
      toast.current?.show({
        severity: 'success',
        summary: 'Success Message',
        detail: '<%= capEntityName %> created successfully',
        life: 3000,
      });
    }
  };

  const pageChanges = (event: any) => {
    setQueryParams({
      ...queryParams,
      page: event.page,
      first: event.first,
      rows: event.rows,
    });
  };

  const onSort = (event) => {
    setQueryParams({
      ...queryParams,
      sortField: event.sortField,
      sortOrder: event.sortOrder,
    });
  };

  /**When filter change update queryParam filter property */
  const onFilter = (event: any) => {
    if (Object.keys(event.filters).length) {
      event['first'] = 0;
      setQueryParams({
        ...queryParams,
        optionalFilters: { ...event.filters },
      });
    }
  };

  const confirmDelete = (<%= camelEntityName %>: <%= capEntityName %>) => {
    confirmDialog({
      header: 'Confirm Detele <%= capEntityName %>',
      message: 'Are you sure you want to delete this <%= capEntityName %>',
      accept: () => deteleMutation.mutate(<%= camelEntityName %>.id!),
    });
  };

  const header = () => {
    return (
      <div className="flex flex-row justify-content-between align-items-center">
        <span className="text-lg"><%= entityName %></span>

        <div className="flex flex-row justify-content-start align-items-center gap-1">
          <Button
            type="button"
            icon="pi pi-filter-slash"
            label="Clear filter"
            className="p-button-text p-button-plain"
            onClick={clearFilters}
          />
          <Button
            icon="pi pi-plus"
            className="p-button-raised"
            onClick={() => createOrEdit()}
            label="Create <%= capEntityName %>"></Button>
        </div>
      </div>
    );
  };

  const actions = (rowData: <%= capEntityName %>) => {
    return (
      <TableAction
        rowData={rowData}
        edit={createOrEdit}
        confirmDelete={confirmDelete}
      />
    );
  };

  return (
    <div className="flex flex-column gap-2">
      <Card style={{ width: '100%' }}>
        {isError ? (
          <span>
            Error loading Data please referesh{' '}
            <Button onClick={() => refetch()} label="Reload"></Button>
          </span>
        ) : (
          <DataTable
            header={header}
            showGridlines
            size="small"
            lazy
            paginator
            first={queryParams.first}
            rows={queryParams.rows}
            totalRecords={<%= camelPluralEntityName %>?.total}
            onPage={pageChanges}
            filters={optionalFilters}
            rowsPerPageOptions={perPageOptions}
            filterDisplay="menu"
            dataKey="id"
            onFilter={onFilter}
            value={<%= camelPluralEntityName %>?.data}
            loading={isLoading}
            onSort={onSort}
            sortField={queryParams.sortField}
            sortOrder={queryParams.sortOrder}
            style={{ width: '100%' }}>
            <%_ fields.forEach(function(f){ _%>
              <%_ if (f.name != 'id' && allMandatory.indexOf(f.name) === -1) { _%> 
                <Column
                <%_ if(f.searchable){ _%>
                  filter
                  sortable
                  filterPlaceholder="Search by <%= f.header %>"
                  <%_ } _%>
                  field="<%=f.camelName %>"
                  header="<%= f.header %>"
                />
              <%_ } _%>
            <%_ }); _%>
            <Column className="actions" body={actions} />
          </DataTable>
        )}
        {showCreateOrUpdate && (
          < <%= capEntityName %>Update
            show={showCreateOrUpdate}
            <%= camelEntityName %>={<%= camelEntityName %>}
            onClose={closeDialog}
          />
        )}
      </Card>
      <Toast ref={toast} />
      <ConfirmDialog />
    </div>
  );
}
